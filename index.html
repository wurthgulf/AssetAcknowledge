<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Würth Bonus Processor v2.2</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .drop-zone { 
            border: 2px dashed #cbd5e1; 
            transition: all 0.3s ease;
        }
        .drop-zone.dragover { 
            border-color: #ef4444; 
            background-color: #fef2f2; 
        }
        .drop-zone.uploaded {
            border-color: #22c55e;
            background-color: #f0fdf4;
        }
        .step-badge {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            font-weight: bold;
        }
        .table-header { @apply px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider bg-gray-100 border-b; }
        .table-cell { @apply px-4 py-3 whitespace-nowrap text-sm text-gray-900 border-b border-gray-100; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-20">

    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-red-600 text-2xl font-extrabold mr-2">WÜRTH</span>
                    <span class="text-gray-600 font-semibold text-lg">| Sales Compensation Engine v2.2</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6 overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center">
                    <div class="step-badge bg-red-100 text-red-700 mr-3">1</div>
                    <h2 class="text-lg font-bold text-gray-800">Upload Source Files</h2>
                </div>
                <button onclick="location.reload()" class="text-sm text-gray-400 hover:text-red-600 underline">Reset All</button>
            </div>
            
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="drop-zone rounded-lg p-6 text-center cursor-pointer relative group" id="drop-hr">
                    <input type="file" id="file-hr" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx,.csv" onchange="handleFile(this, 'hr')">
                    <i class="fa-solid fa-users text-3xl text-gray-300 mb-3 group-hover:text-red-400"></i>
                    <h3 class="font-bold text-gray-700 text-sm">HR & Tenure</h3>
                    <p class="text-xs text-gray-400 mt-1" id="name-hr">Drag or Click</p>
                </div>

                <div class="drop-zone rounded-lg p-6 text-center cursor-pointer relative group" id="drop-sales">
                    <input type="file" id="file-sales" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx,.csv" onchange="handleFile(this, 'sales')">
                    <i class="fa-solid fa-chart-line text-3xl text-gray-300 mb-3 group-hover:text-red-400"></i>
                    <h3 class="font-bold text-gray-700 text-sm">Sales Performance</h3>
                    <p class="text-xs text-gray-400 mt-1" id="name-sales">Drag or Click</p>
                </div>

                <div class="drop-zone rounded-lg p-6 text-center cursor-pointer relative group" id="drop-comm">
                    <input type="file" id="file-comm" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx,.csv" onchange="handleFile(this, 'comm')">
                    <i class="fa-solid fa-file-invoice-dollar text-3xl text-gray-300 mb-3 group-hover:text-red-400"></i>
                    <h3 class="font-bold text-gray-700 text-sm">Commission Data</h3>
                    <p class="text-xs text-gray-400 mt-1" id="name-comm">Drag or Click</p>
                </div>

                <div class="drop-zone rounded-lg p-6 text-center cursor-pointer relative group" id="drop-cust">
                    <input type="file" id="file-cust" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx,.csv" onchange="handleFile(this, 'cust')">
                    <i class="fa-solid fa-user-plus text-3xl text-gray-300 mb-3 group-hover:text-red-400"></i>
                    <h3 class="font-bold text-gray-700 text-sm">Customer Bonus</h3>
                    <p class="text-xs text-gray-400 mt-1" id="name-cust">Drag or Click</p>
                </div>
            </div>
        </div>

        <div id="step-config" class="hidden bg-white rounded-lg shadow-sm border border-gray-200 mb-6 transition-all">
            <div class="p-6 border-b border-gray-100 flex items-center">
                <div class="step-badge bg-red-100 text-red-700 mr-3">2</div>
                <h2 class="text-lg font-bold text-gray-800">Map Columns & Settings</h2>
            </div>
            
            <div class="p-6">
                <div class="mb-6 p-4 bg-gray-50 rounded border border-gray-100">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Processing Date (For Tenure Calculation)</label>
                    <input type="date" id="process-date" class="border border-gray-300 rounded p-2 text-sm w-full md:w-1/3 focus:border-red-500 focus:ring-1 focus:ring-red-500">
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <div class="space-y-4">
                        <h3 class="font-bold text-gray-800 border-b pb-2">Common Identifiers (from HR File)</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Sales Unit (ID) <span class="text-red-500">*</span></label>
                                <select id="map-id" class="w-full border p-2 rounded text-sm bg-white"></select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Employee Name</label>
                                <select id="map-name" class="w-full border p-2 rounded text-sm bg-white"></select>
                            </div>
                        </div>

                        <h3 class="font-bold text-gray-800 border-b pb-2 pt-4">HR File Logic</h3>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Joining Date</label>
                            <select id="map-join-date" class="w-full border p-2 rounded text-sm bg-white"></select>
                        </div>

                        <h3 class="font-bold text-gray-800 border-b pb-2 pt-4">Commission File Logic</h3>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Commission Amount</label>
                            <select id="map-commission" class="w-full border p-2 rounded text-sm bg-white"></select>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="font-bold text-gray-800 border-b pb-2">Sales Performance Logic</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Turnover (AED)</label>
                                <select id="map-turnover" class="w-full border p-2 rounded text-sm bg-white"></select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Target Fulfillment (STF %)</label>
                                <select id="map-stf" class="w-full border p-2 rounded text-sm bg-white"></select>
                            </div>
                        </div>

                        <h3 class="font-bold text-gray-800 border-b pb-2 pt-4">Customer Bonus Logic</h3>
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">MBC Score (Calc)</label>
                                <select id="map-mbc" class="w-full border p-2 rounded text-sm bg-white"></select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">CB Result (Calc)</label>
                                <select id="map-cb" class="w-full border p-2 rounded text-sm bg-white"></select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Division (Display)</label>
                                <select id="map-division" class="w-full border p-2 rounded text-sm bg-white"></select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">%MBC (Display)</label>
                                <select id="map-pct-mbc" class="w-full border p-2 rounded text-sm bg-white"></select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">%CB (Display)</label>
                                <select id="map-pct-cb" class="w-full border p-2 rounded text-sm bg-white"></select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">New + React (Count)</label>
                                <select id="map-new-cust" class="w-full border p-2 rounded text-sm bg-white"></select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button onclick="calculateAndPreview()" class="bg-gray-900 text-white px-6 py-2 rounded shadow hover:bg-black transition-colors flex items-center">
                        <i class="fa-solid fa-table-list mr-2"></i> Preview Results
                    </button>
                </div>
            </div>
        </div>

        <div id="step-preview" class="hidden bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
            <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center">
                    <div class="step-badge bg-green-100 text-green-700 mr-3">3</div>
                    <h2 class="text-lg font-bold text-gray-800">Preview & Download</h2>
                </div>
                <button onclick="downloadExcel()" class="bg-red-600 text-white px-6 py-2 rounded shadow hover:bg-red-700 font-bold transition-colors flex items-center">
                    <i class="fa-solid fa-download mr-2"></i> Download Excel
                </button>
            </div>
            
            <div class="overflow-x-auto p-6">
                <table class="min-w-full divide-y divide-gray-200" id="preview-table">
                    <thead>
                        <tr>
                            <th class="table-header">Sales Unit</th>
                            <th class="table-header">Name</th>
                            <th class="table-header">Division</th>
                            <th class="table-header text-right">Target Fulfillment</th>
                            <th class="table-header text-right">Turnover</th>
                            <th class="table-header text-right">%MBC</th>
                            <th class="table-header text-right">%CB</th>
                            <th class="table-header text-right">Seniority</th>
                            <th class="table-header text-right">Commission</th>
                            <th class="table-header text-right">STF Bonus</th>
                            <th class="table-header text-right">Cust Bonus</th>
                            <th class="table-header text-right text-red-600 font-bold">Total Payout</th>
                            <th class="table-header">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="preview-body">
                        </tbody>
                </table>
                <p class="text-xs text-gray-400 mt-4 text-center">* Preview showing first 10 rows only. Download full file to see all data.</p>
            </div>
        </div>

    </main>

    <script>
        const store = {
            data: { hr: null, sales: null, comm: null, cust: null },
            headers: { hr: [], sales: [], comm: [], cust: [] },
            calculatedResults: []
        };

        document.getElementById('process-date').valueAsDate = new Date();

        // --- File Handling ---
        async function handleFile(input, type) {
            const file = input.files[0];
            if (!file) return;

            const dropZone = document.getElementById(`drop-${type}`);
            const nameLabel = document.getElementById(`name-${type}`);
            nameLabel.innerText = "Loading...";

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer);
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {defval: ""});

                if (jsonData.length === 0) throw new Error("File is empty");

                store.data[type] = jsonData;
                store.headers[type] = Object.keys(jsonData[0]);

                dropZone.classList.add('uploaded');
                nameLabel.innerText = file.name;
                nameLabel.classList.add('text-green-600', 'font-semibold');
                
                checkAllFilesLoaded();

            } catch (err) {
                console.error(err);
                nameLabel.innerText = "Error loading file";
                nameLabel.classList.add('text-red-500');
            }
        }

        function checkAllFilesLoaded() {
            if (store.data.hr && store.data.sales && store.data.comm && store.data.cust) {
                initMapping();
            }
        }

        // --- Mapping Logic ---
        function initMapping() {
            document.getElementById('step-config').classList.remove('hidden');
            
            // HR File
            populateSelect('map-id', store.headers.hr);
            populateSelect('map-name', store.headers.hr);
            populateSelect('map-join-date', store.headers.hr);
            
            // Sales File
            populateSelect('map-turnover', store.headers.sales);
            populateSelect('map-stf', store.headers.sales);
            
            // Commission File
            populateSelect('map-commission', store.headers.comm);
            
            // Customer Bonus File
            populateSelect('map-mbc', store.headers.cust);
            populateSelect('map-cb', store.headers.cust);
            populateSelect('map-new-cust', store.headers.cust);
            populateSelect('map-division', store.headers.cust);
            populateSelect('map-pct-mbc', store.headers.cust);
            populateSelect('map-pct-cb', store.headers.cust);

            // Auto-Suggest Mappings
            autoMap('map-id', ['sales unit', 'id', 'code']);
            autoMap('map-name', ['sales name', 'employee name', 'name']);
            autoMap('map-join-date', ['joined', 'date', 'start']);
            
            autoMap('map-turnover', ['turnover', 'sales', 'revenue']);
            autoMap('map-stf', ['fulfillment', 'target fulfillment', 'stf']);
            
            autoMap('map-commission', ['commission', 'incentive']);
            
            autoMap('map-mbc', ['mbc after qc', 'mbc']);
            autoMap('map-cb', ['cb after qc', 'cb']);
            autoMap('map-division', ['division', 'sector']);
            autoMap('map-pct-mbc', ['%mbc']);
            autoMap('map-pct-cb', ['%cb']);
            autoMap('map-new-cust', ['new after qc', 'new']);
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            select.innerHTML = '<option value="">-- Select Column --</option>';
            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt;
                el.innerText = opt;
                select.appendChild(el);
            });
        }

        function autoMap(selectId, keywords) {
            const select = document.getElementById(selectId);
            const options = Array.from(select.options);
            for (let kw of keywords) {
                const match = options.find(opt => opt.value.toLowerCase().includes(kw));
                if (match) {
                    select.value = match.value;
                    return; 
                }
            }
        }

        // --- Calculation Engine ---
        function calculateAndPreview() {
            const map = {
                id: document.getElementById('map-id').value,
                name: document.getElementById('map-name').value,
                joinDate: document.getElementById('map-join-date').value,
                turnover: document.getElementById('map-turnover').value,
                stf: document.getElementById('map-stf').value,
                comm: document.getElementById('map-commission').value,
                mbc: document.getElementById('map-mbc').value,
                cb: document.getElementById('map-cb').value,
                newCust: document.getElementById('map-new-cust').value,
                division: document.getElementById('map-division').value,
                pctMbc: document.getElementById('map-pct-mbc').value,
                pctCb: document.getElementById('map-pct-cb').value
            };

            if (!map.id || !map.joinDate) {
                alert("Please map at least Sales Unit (ID) and Joining Date.");
                return;
            }

            const processDate = document.getElementById('process-date').valueAsDate;
            const idxSales = createIndex(store.data.sales, map.id);
            const idxComm = createIndex(store.data.comm, map.id);
            const idxCust = createIndex(store.data.cust, map.id);

            store.calculatedResults = [];

            store.data.hr.forEach(row => {
                let empID = String(row[map.id] || "").trim();
                if (!empID) return;

                let empName = map.name ? (row[map.name] || "") : "";
                
                // 1. Tenure
                let joinDateStr = row[map.joinDate];
                let monthsWorked = getMonthsDiff(joinDateStr, processDate);
                let yearsWorked = monthsWorked / 12;
                
                // Seniority Bonus
                let senBonus = 0;
                if (monthsWorked >= 13) {
                    if (yearsWorked >= 12) senBonus = 4000;
                    else if (yearsWorked >= 9) senBonus = 3000;
                    else if (yearsWorked >= 6) senBonus = 2000;
                    else if (yearsWorked >= 3) senBonus = 1000;
                    else if (yearsWorked >= 1) senBonus = 500;
                }

                // 2. Sales Data (STF)
                let sData = idxSales[empID] || {};
                let turnover = parseNum(sData[map.turnover]);
                let stf = parseNum(sData[map.stf]); // Target Fulfillment

                let stfBonus = 0;
                // Note: Assuming STF in file is e.g. 1.05 for 105%. Convert to 105 scale
                // If the file has 1.05, we multiply by 100. If it has 105, we keep 105.
                // Heuristic: if value is < 5, assume decimal percentage.
                let stfScale = stf;
                if (stf < 5 && stf > 0) stfScale = stf * 100;
                
                if (stfScale >= 100) {
                    if (stfScale >= 121 && turnover >= 131000) stfBonus = turnover * 0.02;
                    else stfBonus = getMatrixBonus(stfScale, turnover);
                }

                // 3. Customer Bonus & Extra Fields
                let cData = idxCust[empID] || {};
                let division = map.division ? (cData[map.division] || "") : "";
                let valPctMbc = map.pctMbc ? (cData[map.pctMbc] || "") : "";
                let valPctCb = map.pctCb ? (cData[map.pctCb] || "") : "";
                
                let custBonus = 0;
                let note = "";

                if (monthsWorked <= 7) {
                    // New Emp logic (simplified for new + react)
                    // Note: If you need to map "React" separately, we can add that back. 
                    // Assuming "NewCust" column might contain total or we use just one for now.
                    let nc = parseNum(cData[map.newCust]); 
                    // For precise new vs react logic, ensure both cols are mapped. 
                    // Currently using simplified mapping based on previous request.
                    
                    if (nc >= 6) {
                         if (monthsWorked >= 5 && monthsWorked <= 7) {
                            if (stfScale >= 90) custBonus = 1500;
                            else note = "New Emp: <90% STF";
                        } else {
                            custBonus = 1500;
                        }
                    }
                } else {
                    if (stfScale >= 90) {
                        let mbc = parseNum(cData[map.mbc]);
                        let cbVal = parseNum(cData[map.cb]);
                        custBonus = getCustMatrix(mbc, cbVal);
                    } else {
                        note = "<90% STF";
                    }
                }

                // 4. Commission
                let cmData = idxComm[empID] || {};
                let comm = parseNum(cmData[map.comm]);

                store.calculatedResults.push({
                    SalesUnit: empID,
                    Name: empName,
                    Division: division,
                    TargetFulfillment: stf, // Raw value from file
                    Turnover: turnover,
                    PctMBC: valPctMbc,
                    PctCB: valPctCb,
                    SeniorityBonus: senBonus,
                    Commission: comm,
                    STFBonus: stfBonus,
                    CustBonus: custBonus,
                    Total: senBonus + stfBonus + custBonus + comm,
                    Notes: note
                });
            });

            renderPreview();
        }

        function createIndex(data, idCol) {
            let idx = {};
            if(!data || data.length === 0) return idx;
            let keys = Object.keys(data[0]);
            let keyToUse = keys.includes(idCol) ? idCol : keys[0];
            data.forEach(row => {
                let k = String(row[keyToUse] || "").trim();
                if(k) idx[k] = row;
            });
            return idx;
        }

        function parseNum(val) {
            if (!val) return 0;
            if (typeof val === 'number') return val;
            let v = val.toString().replace(/[^0-9.-]/g, '');
            return parseFloat(v) || 0;
        }

        function getMonthsDiff(d1, d2) {
            let start = typeof d1 === 'number' ? new Date((d1 - 25569)*86400*1000) : new Date(d1);
            if (isNaN(start)) return 0;
            let months = (d2.getFullYear() - start.getFullYear()) * 12;
            months -= start.getMonth();
            months += d2.getMonth();
            return months >= 0 ? months + 1 : 0;
        }

        function getMatrixBonus(stf, turn) {
            let col = 0;
            if (turn >= 131000) col = 3;
            else if (turn >= 111000) col = 2;
            else if (turn >= 91000) col = 1;

            if (stf >= 121) return [1500, 2000, 2500, 0][col];
            if (stf >= 116) return [1250, 1750, 2250, 2400][col];
            if (stf >= 110) return [1000, 1500, 2000, 2250][col];
            if (stf >= 105) return [750, 1250, 1500, 1750][col];
            return [500, 1000, 1250, 1500][col];
        }

        function getCustMatrix(mbc, cb) {
            const matrix = {
                30: [1000, 1250, 1500],
                35: [1100, 1350, 1600],
                40: [1200, 1500, 1700],
                45: [1300, 1650, 2000],
                50: [1400, 1750, 2500],
                55: [1500, 2000, 3000]
            };
            let rowKey = 0;
            [55, 50, 45, 40, 35, 30].some(k => { if (mbc > k) { rowKey = k; return true; } });
            if (rowKey === 0) return 0;

            let cIdx = 0;
            if (cb >= 4) cIdx = 2;
            else if (cb >= 3) cIdx = 1;
            else if (cb >= 2) cIdx = 0;
            else return 0;
            return matrix[rowKey][cIdx];
        }

        function renderPreview() {
            const tbody = document.getElementById('preview-body');
            tbody.innerHTML = "";
            document.getElementById('step-preview').classList.remove('hidden');

            store.calculatedResults.slice(0, 10).forEach(r => {
                const tr = document.createElement('tr');
                
                // Format Percentages for display
                let dispSTF = (typeof r.TargetFulfillment === 'number' && r.TargetFulfillment < 5) 
                    ? (r.TargetFulfillment * 100).toFixed(1) + '%' 
                    : r.TargetFulfillment;
                    
                let dispPctMBC = (typeof r.PctMBC === 'number' && r.PctMBC < 5) 
                    ? (r.PctMBC * 100).toFixed(1) + '%' 
                    : r.PctMBC;

                let dispPctCB = (typeof r.PctCB === 'number' && r.PctCB < 5) 
                    ? (r.PctCB * 100).toFixed(1) + '%' 
                    : r.PctCB;

                tr.innerHTML = `
                    <td class="table-cell font-medium">${r.SalesUnit}</td>
                    <td class="table-cell text-gray-700">${r.Name}</td>
                    <td class="table-cell text-gray-500">${r.Division}</td>
                    <td class="table-cell text-right">${dispSTF}</td>
                    <td class="table-cell text-right">${fmtMoney(r.Turnover)}</td>
                    <td class="table-cell text-right">${dispPctMBC}</td>
                    <td class="table-cell text-right">${dispPctCB}</td>
                    <td class="table-cell text-right">${fmtMoney(r.SeniorityBonus)}</td>
                    <td class="table-cell text-right">${fmtMoney(r.Commission)}</td>
                    <td class="table-cell text-right">${fmtMoney(r.STFBonus)}</td>
                    <td class="table-cell text-right">${fmtMoney(r.CustBonus)}</td>
                    <td class="table-cell text-right font-bold text-red-600">${fmtMoney(r.Total)}</td>
                    <td class="table-cell text-xs text-gray-400 italic">${r.Notes}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function fmtMoney(num) {
            return new Intl.NumberFormat('en-AE', { style: 'decimal', minimumFractionDigits: 2 }).format(num);
        }

        function downloadExcel() {
            if (store.calculatedResults.length === 0) return;
            const ws = XLSX.utils.json_to_sheet(store.calculatedResults);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Payroll Data");
            XLSX.writeFile(wb, `Wurth_Bonus_Calc_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
    </script>
</body>
</html>
